# 진입 규칙 문서 (Entry Rules & Signal Options)
> 본 문서는 `spec_updated_v2.md`, `capital_management_rules_v2.md`와 함께 사용되는 **진입(Entry) 신호 규칙**을 정의한다.  
> 진입 규칙은 단일 고정이 아니라 **옵션 파라미터(열거형)로 관리**하며, 백테스트/전진분석을 통해 선택/검증한다.  
> 업데이트: 2026-02-10 (Asia/Seoul)

---

## 1) 적용 범위 및 공통 전제
### 1.1 시장/세션/집행
- 거래소: **KRX만 사용**
- 모든 주문 체결 시간대: **09:00 ~ 15:20** (세션 내 체결 가정)
- 진입 주문 방식: **익일 09:00 시장가**  
  - 신호 산출 시점: `T일 종가(C)`  
  - 진입 체결 시점(근사): `T+1일 시가(O)` (09:00 시장가)

### 1.2 데이터
- 가격 데이터는 **항상 수정주가(Adjusted OHLC)** 를 사용한다.
- 지표 계산도 수정주가 기준으로 수행한다.

### 1.3 포지션/한도 게이트(진입 공통 필터)
진입 신호가 발생해도 아래를 만족하지 않으면 **주문을 생성하지 않는다.**

- (G1) 동일 종목 롱/숏 동시 보유 금지
  - 해당 종목에 이미 포지션이 있으면(롱/숏), **반대 방향 신규 진입 금지**
- (G2) 유닛/익스포저 한도
  - 종목별 최대 4 units, 전체 최대 10 units (`capital_management_rules_v2.md` 참조)
- (G3) 숏 유니버스 제약
  - 숏 진입은 **허용된 숏 유니버스(예: 코스피 시총 Top10)** 에서만 가능
- (G4) 숏 명목 한도
  - 신규 숏(대주매도) 전, **대주매도 체결가격 기준 숏 명목 합**이 한도 이내인지 확인  
  - (백테스트 가정) 5.7억, (실운영 상위 정책) 6억 (`capital_management_rules_v2.md` 참조)

> 진입 후 손절/TS/피라미딩/강제청산(90거래일)은 별도 문서의 규칙을 따른다.

---

## 2) 진입 규칙은 “옵션 파라미터”로 관리
- 진입 규칙은 `entry_rule_type`이라는 옵션 파라미터로 관리한다.
- 후보군:
  - **Type A: Turtle(돈치안 브레이크아웃) 계열**
  - **Type B: 회귀 기반(정규화 기울기 + R²) 계열**
  - **Strategy C: 시계열 모멘텀 + 이동평균선 대순환(6단계) + 시장(지수) 필터**

---

## 3) 성능 검증 원칙(승률 35% 기준)
- 진입 규칙 옵션은 **KOSPI 시장에 대해** 백테스트 후 성능을 검토한다.
- 목표 기준:
  - **승률(Trade Win Rate) ≥ 35%** 달성 여부를 확인한다.
- 평가 구간은 `spec_updated_v2.md`에 정의된 기간을 따른다.
  - In-sample(백테스트): 2017~2020
  - OOS(전진분석): 2021~2024

> 실무 적용 권장: “In-sample 통과 + OOS에서 붕괴하지 않는지”를 함께 확인.

---

## 4) Type A — Turtle Trading(돈치안 브레이크아웃)
Type A는 돈치안 채널 돌파를 사용한다.  
돈치안 채널은 **과거 N일의 고가/저가 범위**를 이용한다.

### 4.1 돈치안 채널 정의(룩어헤드 방지)
- 상단(Upper):
  - `DonchianHigh_N(T) = max( H_{T-N} ... H_{T-1} )`
- 하단(Lower):
  - `DonchianLow_N(T)  = min( L_{T-N} ... L_{T-1} )`

> 신호는 `T일 종가(C_T)` 기준으로 판단한다.

---

### 4.2 Type A.1 — 돈치안 브레이크아웃(20)
- 파라미터: `N = 20`

#### Long 진입 신호(롱)
- 조건:
  - `C_T >= DonchianHigh_20(T)`
- 실행:
  - `T+1 09:00 시장가`로 1 unit 진입

#### Short 진입 신호(숏, 대주)
- 조건:
  - `C_T <= DonchianLow_20(T)`
- 실행:
  - `T+1 09:00 시장가`로 1 unit 숏 진입(대주매도)

---

### 4.3 Type A.2 — PL 필터(Profit/Loss Filter) (A.1에만 적용)
- 목적: 직전 거래가 “수익”이었을 경우, **A.1의 반대 방향 진입 신호**를 무시한다.
- 정의:
  - 각 종목별로 “직전 종료된 트레이드”의 방향(`last_dir ∈ {long, short}`)과 손익(`last_pnl`)을 저장한다.
  - `last_pnl > 0`인 경우에 한해 필터가 활성화된다.

#### 필터 규칙
- 만약 `last_pnl > 0`이고, A.1에서 발생한 이번 진입 방향이 `last_dir`의 **반대 방향**이라면:
  - 해당 A.1 신호는 **무시(진입하지 않음)**

예시:
- 직전 거래가 **long이고 수익**이었다면 → 이번 A.1의 **short 진입 신호**는 무시
- 직전 거래가 **short이고 수익**이었다면 → 이번 A.1의 **long 진입 신호**는 무시

> 주: 본 필터는 **A.3(55)에는 적용하지 않는다.**

---

### 4.4 Type A.3 — 돈치안 브레이크아웃(55), PL 필터 무시
- 파라미터: `N = 55`
- 특징:
  - 돈치안 55 규칙에서는 **PL 필터(A.2)를 무시**하고,
  - 신호가 발생하면 **상시 원하는 방향으로 진입**한다(=신호 항상 실행).

#### Long 진입 신호
- `C_T >= DonchianHigh_55(T)` → `T+1 09:00 시장가`로 1 unit 롱

#### Short 진입 신호
- `C_T <= DonchianLow_55(T)` → `T+1 09:00 시장가`로 1 unit 숏

---

## 5) Type B — 회귀 기반(정규화 기울기 + R²) 진입
Type B는 “추세의 방향(기울기)”과 “선형 추세의 설명력(R²)”을 함께 사용한다.

### 5.1 왜 ‘기울기 정규화’가 필요한가(요약)
일반적인 선형 회귀 기울기(slope)는 단위가 `ΔPrice/ΔTime`이므로,  
가격 레벨이 큰 종목이 기울기가 더 크게 보이는 왜곡이 발생한다.

- A 종목(1,000원): 하루 10원 상승 → slope = 10 (≈ +1%/day)
- B 종목(100,000원): 하루 100원 상승 → slope = 100 (≈ +0.1%/day)

단순 slope만 보면 B가 더 강해 보이지만, 수익률 관점의 추세는 A가 더 강하다.  
따라서 slope를 “가격 대비 비율”로 정규화한다.

### 5.2 정규화 기울기(Percentage Slope) 정의
- 회귀 구간: 최근 `W = 20`일
- 종속변수: `y_i = Close_{t-W+1+i}` (i=0..W-1)
- 독립변수: `x_i = i` (0..W-1)
- 회귀식: `y = a + b x`
  - `b`가 회귀 기울기(slope, KRW/day)

정규화:
- `NormalizedSlope_t = ( b / C_t ) * 100`

> 단위: “%/day”에 가까운 해석이 가능하다.

### 5.3 R-square 조건
- 동일 회귀에서 계산된 `R²`가:
  - `R² > 0.6`일 때만 신호 유효

### 5.4 60일 이동평균 방향 필터
- `MA60_t = SMA(Close, 60)` (기본은 단순이평; 필요 시 EMA로 변경 가능)
- 필터:
  - `C_t < MA60_t`이면 **long 금지**
  - `C_t > MA60_t`이면 **short 금지**

---

### 5.5 Type B.1 — 정규화 기울기(20) 0선 돌파 + R²
- 파라미터:
  - `W = 20`
  - `R2_threshold = 0.6`

#### Long 진입 신호
- 조건(동시에 만족):
  1) `NormalizedSlope_{T-1} <= 0` 그리고 `NormalizedSlope_T > 0`  (0 상향 돌파)
  2) `R²_T > 0.6`
  3) `C_T >= MA60_T` (Type B.2 필터)

- 실행:
  - `T+1 09:00 시장가`로 1 unit 롱

#### Short 진입 신호
- 조건(동시에 만족):
  1) `NormalizedSlope_{T-1} >= 0` 그리고 `NormalizedSlope_T < 0`  (0 하향 돌파)
  2) `R²_T > 0.6`
  3) `C_T <= MA60_T` (Type B.2 필터)

- 실행:
  - `T+1 09:00 시장가`로 1 unit 숏(대주매도)

---

## 6) 설정 예시(구현 관점)
아래는 YAML/JSON 스타일로 진입 규칙 옵션을 고정하는 예시이다(실제 키 이름은 구현에서 확정).

```yaml
entry:
  rule_type: "A_20_PL"     # ["A_20_PL", "A_55", "B_SLOPE20"]
  turtle:
    donchian_window_1: 20
    donchian_window_2: 55
    pl_filter: true        # A_20_PL에서만 true
  regression:
    window: 20
    r2_threshold: 0.6
    ma_window: 60
    ma_type: "SMA"
```

---

## 7) 구현 메모(중요)
- 진입 신호는 “후보 신호”이고, 실제 주문 생성은 섹션 1.3의 **게이트를 모두 통과**해야 한다.
- 진입 후 청산/피라미딩은 `capital_management_rules_v2.md`의 규칙을 따른다.
- Type A.2(PL 필터)의 “직전 거래”는 **종목 단위**로 관리하는 것을 기본으로 한다.


---

## 6) Strategy C — 시계열 모멘텀 + 이동평균선 대순환(6단계) + 시장(지수) 필터
### 6.1 목적/가정
- 대상: **삼성전자처럼 사이클(경기 민감) 성격이 강한 종목**에서 “큰 상승 국면”만 취하는 것을 목표로 한다.
- 지향점(원리 시험):
  - 승률(Win Rate) ≈ 35%
  - 손익비(Avg Win / Avg Loss) ≈ 5

> 주: 손절/TS/피라미딩/비용 모델은 기존 문서(`capital_management_rules_v2.md`) 규칙을 그대로 따른다.

### 6.2 모멘텀 정의(기본: 63거래일)
- `MOM_L(T) = Close_T / Close_{T-L} - 1`
- 기본 `L=63` (약 3개월)
- 코드 컬럼명: `mom_{L}` (예: `mom_63`)

### 6.3 이동평균선 대순환(6단계) 정의 (EMA 5/20/40)
세 개의 EMA를 계산한다.
- 단기: `EMA_5`
- 중기: `EMA_20`
- 장기: `EMA_40`

**단계(위→아래 순서)**
1) `EMA_5 > EMA_20 > EMA_40`  
2) `EMA_20 > EMA_5 > EMA_40`  
3) `EMA_20 > EMA_40 > EMA_5`  
4) `EMA_40 > EMA_20 > EMA_5`  
5) `EMA_40 > EMA_5 > EMA_20`  
6) `EMA_5 > EMA_40 > EMA_20`

- 코드 컬럼명: `cycle_phase_{s}_{m}_{l}` (예: `cycle_phase_5_20_40`)
- 동점(동일값) 등으로 순서가 불명확한 경우 phase는 NaN으로 처리(=필터 불통과).

### 6.4 진입 필터(롱만)
**롱 허용 구간:** 6단계 → 1단계 → 2단계  
즉, 롱은 아래 두 조건이 모두 성립할 때만 허용한다.

- (종목 필터) `stock_phase ∈ {6,1,2}`
- (시장 필터) `market_phase ∈ {6,1,2}`  
  - 시장 phase는 **KOSPI200 선물(지수)** CSV로부터 산출한다.
  - 코드 컬럼명: `mkt_cycle_phase_5_20_40` (prefix 기본값 `mkt`)

### 6.5 Strategy C 진입 규칙(레짐 엔트리)
종가 기반 판단(T), 익일 시가 진입(T+1 09:00):

- `MOM_63(T) > +5%`
- `stock_phase(T) ∈ {6,1,2}`
- `market_phase(T) ∈ {6,1,2}`

그리고 **조건이 True로 “처음 전환되는 날”에만 진입**한다.
- `cond(T)=True` AND `cond(T-1)=False` → `T+1` 시가에 1 unit 매수

### 6.6 Strategy C 레짐 청산(옵션, 기본 ON)
포지션 보유 중 아래 중 하나라도 성립하면, 다음날 시가에 전량 청산한다.
- `MOM_63(T) ≤ 0%` (exit threshold)
- `stock_phase(T) ∉ {6,1,2}`
- `market_phase(T) ∉ {6,1,2}`

- 코드 exit_reason: `REGIME_EXIT_C_TSMOM_CYCLE`

### 6.7 실행 방법 (Toy 005930)
```bash
python scripts/toy_005930_backtest.py \
  --csv data/krx100_adj_5000.csv \
  --entry-rule C_TSMOM_CYCLE \
  --market-csv data/kospi200_futures.csv \
  --c-mom-window 63 \
  --c-enter-thr 0.05 \
  --c-exit-thr 0.0 \
  --outdir outputs
```

- `--market-csv`를 주지 않고 실행하려면 `--c-no-market-filter`를 명시해야 한다(시장 필터 비활성).


---

## 부록) Type B 변형(BA/BB)

005930(삼성전자)와 같이 회귀 기반 지표가 **전환점에서 R²가 낮아지는** 종목에서 `B_SLOPE20`이 신호를 거의 만들지 않는 경우가 있어, 아래 변형을 추가했다.

- `BA_REGIME20` (BA 전략)
  - 0선 돌파가 아니라 **regime 진입** 형태
  - `norm_slope_20 > 0` & `r2_20 > 0.6` & `close >= MA60` 조건이 **False→True**로 전환될 때 LONG 진입
  - 숏은 대칭

- `BB_CROSS20_R2PREV` (BB 전략)
  - 0선 돌파는 유지하되, 필터를 `r2_20(t-1)`로 평가
  - 전환 당일의 R² 저하 문제를 완화
