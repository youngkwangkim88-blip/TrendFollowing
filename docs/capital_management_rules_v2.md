# 자금관리 및 청산 규칙 (Capital Management & Exit Rules)
> 본 문서는 `spec_updated_v2.md`를 보완하는 **자금관리/포지션 사이징/피라미딩/청산(손절/TS)/집행 모델**을 정의한다.  
> 업데이트: 2026-02-10 (Asia/Seoul)

---

## 1) Unit 기반 거래(기본 단위)
- 모든 거래는 **unit(유닛)** 을 기본 단위로 한다.
- **one-trading**은 “1 unit”을 기준으로 한 **진입 1회 + 청산 1회**로 구성된다.
  - Long one-trading: `1 unit 매수 → 청산 시 1 unit 매도`
  - Short one-trading(대주): `1 unit 대주매도 → 청산 시 1 unit 대주매수`
- 동일 종목에서 여러 unit을 누적 보유(피라미딩)할 수 있으며, 포지션 관리는:
  - (A) **종목별 합산 포지션**(총 수량/평단) +  
  - (B) **unit 단위 트레이드 로그**  
  를 동시에 유지한다.

---

## 2) 하이퍼파라미터 및 표기
- 연초 기준 총자금: `M`  (KRW)
- one-trading risk: `R = 1% = 0.01` (고정)
- 변동성 파라미터: `ATR10 = ATR(10)` (EMA 기반)
- 종목별(합산) 평균 진입가(평단): `X` (KRW)
- 일봉: `O, H, L, C`
- 롱 보유기간 최고가: `H_max`  
- 숏 보유기간 최저가: `L_min`

---

## 3) ATR(10) 정의(EMA 기반)
### 3.1 True Range(TR)
일자 `t`에서:
- `TR_t = max( H_t - L_t, |H_t - C_{t-1}|, |L_t - C_{t-1}| )`

### 3.2 ATR(10)
- `ATR10_t = EMA(TR, span=10)`
- EMA 계수(권장): `alpha = 2/(10+1)`

### 3.3 “진입에 사용하는 ATR”
- 기본 실행이 `T일 종가 판단 → T+1 09:00 주문`이므로,  
  **ATR10(T)** 를 T+1 주문(사이징/스탑/TS 기준)에 사용한다.

---

## 4) 1 Unit(수량) 정의: Risk-based sizing
연초 총자금 `M`, 리스크 `R`, 변동성 `ATR10`을 사용하여 종목별 1 unit 수량을 정의한다.

- `unit_shares = floor( M * R / ATR10 ) = floor( 0.01 * M / ATR10 )`

> 구현 노트:  
> - `unit_shares`는 정수 주식 수량이다.  
> - KRX 호가단위(틱)와 무관하게 “수량”은 정수로 처리한다.

---

## 5) 포지션 한도(Exposure Constraints)
### 5.1 동일 종목 한도
- 동일 종목 최대 보유: **4 units**
  - `abs(units_per_symbol) ≤ 4`

### 5.2 전체 시스템 한도
- 전체 보유 최대치(절대값 합): **10 units**
  - `sum(abs(units_per_symbol)) ≤ 10`

### 5.3 가용 여유(capacity)
- 추가 진입(피라미딩 포함) 가능 여부는 다음을 모두 만족해야 한다.
  - `abs(units_per_symbol) + 1 ≤ 4`
  - `total_abs_units + 1 ≤ 10`
  - (숏인 경우) **숏 명목 한도**(섹션 9.3) 이내

---

## 6) 집행(Execution) 원칙 및 KRX 세션
### 6.1 시장/세션
- 거래소: **KRX만 사용**
- 모든 주문은 **09:00 ~ 15:20** 사이에 체결되는 것으로 가정한다.
  - 장 마감 이후에 발생한 트리거는 **익일 09:00(시가) 체결**로 처리한다(오버나잇 갭 포함).

### 6.2 주문 유형
- **모든 주문은 시장가(Market)로 집행**한다.
  - 예약 진입(익일 09:00): 시장가
  - 손절/TS 트리거: 트리거 즉시 시장가
  - 강제청산(예: 90거래일 제한): 집행 시점의 시장가

> 운영 구현 메모:  
> 손절/TS의 “트리거 즉시 시장가”를 실현하려면  
> (A) 브로커가 제공하는 조건부/스탑-마켓 주문(서버사이드) 또는  
> (B) 세션 중 주기적 폴링/모니터링(저빈도 가능)  
> 중 하나가 필요하다. (세부는 구현 단계에서 선택)

---

## 7) KRX 호가단위(틱) 반영: 가격 라운딩
본 시스템의 모든 “가격 레벨”(손절가/TS 레벨 등)은 **KRX 틱 단위로 치환**한다.

### 7.1 원칙
- `price_raw`(계산된 이론 가격)을 `tick_size(price_raw)`에 따라 **유효 가격**으로 변환한다.
- 방향성 라운딩(권장):
  - **매도/숏 청산에서 불리하지 않게**(보수적으로) 라운딩한다.
  - 예시:
    - 롱 손절/롱 TS 레벨: **tick-down**(아래 방향)  
    - 숏 손절/숏 TS 레벨: **tick-up**(위 방향)

> 틱 규칙의 가격대별 테이블은 KRX 규정에 따라 코드에 내장한다.  
> (문서에서는 “틱 치환을 한다”는 요구사항만 확정하고, 정확한 표는 구현에서 고정한다.)

---

## 8) 청산 규칙 1: 손절(Initial Stop-loss)
### 8.1 Long 손절가
- 이론 손절가:
  - `X_cut_long_raw = X - 2 * ATR10`
- 실행 손절 레벨(틱 반영):
  - `X_cut_long = tick_down(X_cut_long_raw)`

### 8.2 Short 손절가(대칭)
- 이론 손절가:
  - `X_cut_short_raw = X + 2 * ATR10`
- 실행 손절 레벨(틱 반영):
  - `X_cut_short = tick_up(X_cut_short_raw)`

---

## 9) 청산 규칙 2: Trailing Stop (TS)
TS는 “수익 구간(±20%) 진입 이후”에만 활성화되며, 활성화 후에는 “최고가/최저가 대비 10% 역행 시” 청산한다.

### 9.1 Long TS
#### (1) 활성화 조건
- `H_max >= 1.2 * X` 이면 TS 활성화

#### (2) TS 레벨(이론)
- `TS_long_raw = max( 1.1 * X, 0.9 * H_max )`

#### (3) TS 레벨(틱 반영)
- `TS_long = tick_down(TS_long_raw)`

### 9.2 Short TS(대칭)
#### (1) 활성화 조건
- `L_min <= 0.8 * X` 이면 TS 활성화

#### (2) TS 레벨(이론)
- `TS_short_raw = min( 0.9 * X, 1.1 * L_min )`

#### (3) TS 레벨(틱 반영)
- `TS_short = tick_up(TS_short_raw)`

### 9.3 H_max / L_min 추적 규칙(확정)
- 롱: 진입(또는 피라미딩 직후)부터 `H_max = max(H_max, H_t)`로 갱신
- 숏: 진입(또는 피라미딩 직후)부터 `L_min = min(L_min, L_t)`로 갱신
- **피라미딩(추가 진입) 발생 시점에 H_max / L_min은 반드시 리셋**한다.
  - 롱: 피라미딩 체결일 기준 `H_max := H_{entry_day}` (또는 `max(H_{entry_day}, entry_price)`; 구현에서 고정)
  - 숏: 피라미딩 체결일 기준 `L_min := L_{entry_day}` (또는 `min(L_{entry_day}, entry_price)`; 구현에서 고정)

---

## 10) 피라미딩(Pyramiding)
피라미딩은 “가용 여유(capacity)가 있을 때, 수익 구간에서 1 unit 추가 진입”하는 규칙이다.

### 10.1 Long 피라미딩
- 종목 평단 `X`에 대해, 어떤 날 `T`의 종가가:
  - `C_T >= 1.15 * X`
- 그리고 섹션 5의 한도/가용 여유를 만족하면,
- 다음 거래일 `T+1` **09:00 시장가로 1 unit 추가 매수**한다.

### 10.2 Short 피라미딩(대칭)
- 종목 평단 `X`에 대해, 어떤 날 `T`의 종가가:
  - `C_T <= 0.85 * X`
- 그리고 섹션 5 및 숏 한도(섹션 11)를 만족하면,
- 다음 거래일 `T+1` **09:00 시장가로 1 unit 추가 대주매도**한다.

### 10.3 피라미딩 이후 재설정(확정)
추가 진입이 발생하면, 즉시 아래를 수행한다.
1) **평균 진입가 재계산**
   - `X_new = (Σ(체결가_i * 수량_i)) / (Σ 수량_i)`
2) **ATR10 최신값 재평가**
   - 추가 진입 시점의 최신 ATR10을 사용(섹션 3.3 기준)
3) **기준값 업데이트**
   - `X := X_new`
   - 손절가/TS 레벨을 **새 X, 새 ATR10 기준으로 재계산**
4) **H_max / L_min 리셋**
   - 섹션 9.3 규칙대로 반드시 리셋 후, 그 시점부터 재추적

---

## 11) 스탑/TS 트리거 시 체결가 모델(일봉 OHLC 기준)
모든 스탑/TS 청산은 **시장가 주문**이지만, 백테스트/리포팅에서 체결가는 아래 규칙으로 근사한다.

### 11.1 오버나잇 갭으로 트리거된 경우: 익일 시가(O) 체결
- 롱(손절/TS): `O_t <= stop_level_t` 이면 **갭 트리거**로 간주 → 체결가 `= O_t`
- 숏(손절/TS): `O_t >= stop_level_t` 이면 **갭 트리거**로 간주 → 체결가 `= O_t`

> 여기서 `stop_level_t`는 틱 반영된 레벨(`X_cut` 또는 `TS`)이다.

### 11.2 장중 터치로 트리거된 경우: 터치한 틱 값 체결
- 롱(손절/TS): `O_t > stop_level_t` 이고 `L_t <= stop_level_t` 이면 **장중 터치** → 체결가 `= stop_level_t`
- 숏(손절/TS): `O_t < stop_level_t` 이고 `H_t >= stop_level_t` 이면 **장중 터치** → 체결가 `= stop_level_t`

### 11.3 동일 일자에 손절과 TS가 모두 가능한 경우(우선순위)
- 롱: 더 “타이트한”(더 높은) 레벨이 먼저 체결될 수 있으므로
  - `effective_stop_long = max(X_cut_long, TS_long(활성 시))`
- 숏: 더 “타이트한”(더 낮은) 레벨이 먼저 체결될 수 있으므로
  - `effective_stop_short = min(X_cut_short, TS_short(활성 시))`

> 일봉 데이터만으로는 경로가 불명확하므로, 위 방식은 “먼저 닿을 가능성이 높은 타이트한 레벨”을 적용하는 근사이다.

---

## 12) 공매도(대주) 제약 및 비용(자금관리 관점)
### 12.1 동일 종목 롱/숏 동시 보유 금지(확정)
- 동일 종목에서 롱과 숏을 동시에 보유할 수 없다.
  - 전환은 반드시 **기존 포지션 청산 후** 수행

### 12.2 숏 명목 한도(체결가 기반, 확정)
- 숏 명목(notional)은 **대주매도 체결가격 기준**으로 산정한다.
  - 종목 i에 대해: `notional_i = (대주매도 체결가_i) * (오픈 숏 수량_i)`
  - 전체: `short_notional_total = Σ notional_i`
- 한도:
  - 실운영 상위 정책: `short_notional_total ≤ 600,000,000 KRW`
  - 백테스트 가정: `short_notional_total ≤ 570,000,000 KRW` (증거금 100% + 3천만 버퍼)
- 한도 체크 타이밍:
  - **모든 신규 숏 진입(대주매도) 전** 즉시 체크한다.

#### 주간 집계(요구 반영)
- **매주(주간 리포트/감시 시점)** 위 정의(대주매도 체결가 기준)로 `short_notional_total`을 집계하여 기록/리포트한다.

### 12.3 대주 보유기간 제한(90 거래일, 확정)
- 숏(대주) 포지션은 **90 거래일 이내 청산**해야 한다.
- 90 거래일 초과 시:
  - 다음 가능한 세션(09:00~15:20)에서 **시장가 강제 청산**한다.

### 12.4 대주 이자(연 4.5%, 확정)
- 이자율: 연 **4.5%**
- 비용 누적(기본):
  - 일할 누적: `daily_rate = 0.045/365`
  - 누적 기준 금액: 기본은 `short_notional_total`(대주매도 체결가 기반)로 산정한다.
  - (정교화 가능) 시장가 평가 기반으로 전환 가능하나, 초기 구현은 체결가 기반으로 단순화한다.

---

## 13) 비용 처리 연결(참조)
- 거래비용 0.3% (왕복 근사, 매도 시 0.3% 차감)
  - 롱: 매수 0% / 매도 0.3%
  - 숏: 대주매도 0.3% / 대주매수 0%

> 비용 상세는 `spec`의 비용 모델을 따른다.

