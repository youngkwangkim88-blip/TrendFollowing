# 투자 자동화 시스템 구축 v2 — 요구사항 명세(spec)
> 업데이트: 2026-02-10 (Asia/Seoul 기준)

## 1. 개요
- 목적: **한국 주식(롱 + 제한적 개별 종목 숏(대주)) 기반의 추세추종 시스템**을 Python으로 구현하고, 백테스트/전진분석(워크포워드)/최적화 및 실거래 자동 실행 파이프라인을 구축한다.
- 브로커: **한국투자증권(KIS) OpenAPI**
- 매매 빈도: **연 수십 회 수준(저빈도)**
- 실시간성: 비요구사항(Non-real-time). 배치 실행을 기본으로 한다.
- 데이터/의사결정: **일봉 OHLC 기반**으로 신호를 산출하고, **익일 09:00 시장가 주문**으로 집행한다.

---

## 2. 운용 자금(자본, Capital)
- 초기 운용자금: **700,000,000 KRW (7억 원)**
- 결산일: **매년 12/31 기준(연말 고정)**
- 자본 업데이트:
  - 매년 결산 후 기준 운용자금을 업데이트한다.
  - 결산 방식의 상세(미실현손익 포함 여부, 입출금 반영, 회계 처리 등)는 **별도 문서**로 관리한다. (문서: `capital_reconciliation.md`)

> 세금: ETF/ETN 등 별도 세금 고려는 하지 않는다. 거래세/수수료/슬리피지는 아래 비용 모델에 근사 포함한다.

---

## 3. 성과 목표 및 평가 구간
### 3.1 목표 성과 지표(Target Metrics)
- 목표 MDD: **-15% 이내**
- 목표 수익률: **CAGR 30%**
- 목표 승률(Win Rate): **35%**
- 목표 손익비(Payoff Ratio): **5**

### 3.2 평가 구간(기간 고정)
- 성과 평가는 아래 기간으로 고정한다.
  - **백테스트(In-sample): 2017-01-01 ~ 2020-12-31**
  - **전진분석/워크포워드(OOS): 2021-01-01 ~ 2024-12-31**
- 캘린더 기준:
  - **매년 01/01 시작, 12/31 종료**를 원칙으로 하되,
  - 실제 거래일은 KRX 휴장/주말을 고려하여 **해당 연도의 첫/마지막 거래일**을 사용한다.

> 참고(체결 시점): 신호가 T일 종가 기반이고 체결이 T+1일 시가(09:00 시장가)에 발생하므로,  
> 특정 연도의 12/31 종가에서 생성된 신호의 체결은 다음 거래일로 넘어갈 수 있다.  
> 평가 구간 경계에서의 “마지막 포지션 처리(강제 청산/캐리오버)” 규칙은 추후 확정(TBD) 가능하나, 기본은 **평가 구간 내 성과를 우선**한다.

---

## 4. 시스템/아키텍처 요구사항
- 구현 언어: **Python**
- 브로커 연동: **KIS API(모의/실거래 환경 분리)**
- 리서치 기능(필수):
  - 백테스트(Backtest)
  - 전진분석/워크포워드(Forward / Walk-forward)
  - 파라미터 최적화(Optimization)
- 리포트/플로팅:
  - Python 기본 리포트 + 필요 시 **Python → MATLAB**을 통한 고품질 플로팅 생성(선택)

---

## 5. 거래/집행 규칙(Execution Rules)
- 신호 산출: **T일 종가(Close) 기준**
- 주문 집행: **T+1일 09:00 시장가(Market) 주문**
  - 백테스트 체결가는 기본적으로 **T+1일 시가(Open)** 로 근사한다.
- 미체결/예외 처리:
  - 시장가 주문을 기본으로 하므로 미체결 관리 부담은 낮다고 가정한다.
  - 단, **미체결(또는 부분체결/거부) 발생 시 즉시 텔레그램 알림**을 송신한다.

---

## 6. 투자 대상(Universe) 및 업데이트 정책
### 6.1 유니버스 정의
- 롱(매수) 유니버스:
  - **KRX100 지수 구성 종목**
- 숏(공매도/대주) 유니버스:
  - **코스피 시가총액 상위 10개 종목(예시)** 중심으로 제한 운용
  - 숏 집행은 **KIS API의 대주 매도/대주 매수** 기능을 사용한다(사용자 확인)

### 6.2 유니버스 업데이트
- 기본: **연 단위(연초) 업데이트**를 반영한다.
  - 예: 해당 연도 유니버스는 전년도 말(또는 연초 첫 거래일) 스냅샷을 사용
- 구현 복잡도/유지보수 비용이 과도해지면:
  - **현재 기준 유니버스를 고정**하는 방식도 허용한다(정확도가 크게 중요하지 않음).
- 데이터 소스:
  - 후보: `python-krx` 등을 통한 구성/시총 조회(세부 구현은 추후 결정)

---

## 7. 가격 데이터 및 전처리 규칙
- 가격은 **항상 수정주가(Adjusted Price)** 를 사용한다.
- 배당: **무시**(배당 현금흐름/재투자 모델링을 별도로 하지 않는다).
- 상장폐지/관리종목 등 특수 이벤트:
  - 본 시스템은 유동성이 큰 상위 종목 중심이므로 **원칙적으로 신경 쓰지 않는다(범위 제외)**.
- 거래 공백(예: 액면분할 등으로 1주 내외 거래 없음) 처리:
  - 해당 기간에 해당 종목의 OHLC가 누락되거나 거래가 없으면, 그 기간은 **해당 종목 “거래 불가(Non-tradable)”** 로 취급한다.
  - 포지션 평가(mark-to-market)는 기본적으로:
    - **전일 유효 종가를 유지(Forward-fill)하여 평가**하되,
    - 실제 체결/주문은 **유효한 거래일에만 가능**하도록 제한한다.
  - 스탑/강제청산/만기성 제약(예: 대주 90거래일 제한)이 공백 기간에 걸릴 경우:
    - 원칙: **가장 빠른 다음 유효 거래일에 집행**한다.

---

## 8. 비용 모델(Transaction Cost & Financing)
### 8.1 거래비용(근사)
- 거래 부가 비용(근사): **0.3% (왕복 기준)**
  - 한국 거래세(매도 시), 증권사 수수료, 소정의 슬리피지를 합산한 근사치
- 적용 원칙(확정):
  - **매수(buy) 체결 비용: 0%**
  - **매도(sell) 체결 비용: 0.3% 일괄 차감**
    - 롱 트레이드: 진입(매수) 0% / 청산(매도) 0.3%
    - 숏 트레이드: 진입(대주매도) 0.3% / 청산(대주매수) 0%

### 8.2 숏(대주) 금융비용(이자)
- 대주 비용: **연율 4.5%** 이자 발생
- 적용 방식(기본):
  - 숏 포지션 보유 기간 동안 **일별(또는 날짜 차이 기반)로 이자를 누적**하여 비용으로 반영한다.
  - 연율 → 일할 계산 방식(365일/252거래일 기준)은 구현 시 명확히 고정한다(TBD).  
    - 권장: **캘린더 일수 기준(연 365일)** 으로 일할 계산

---

## 9. 공매도(대주) 제약 조건
### 9.1 동일 종목 롱/숏 동시 보유 금지(확정)
- 개인 계정 운영 제약으로, **동일 종목에 대해 롱과 숏 포지션을 동시에 보유할 수 없다.**
  - 예: 롱 포지션 청산 후에야 숏 진입 가능(또는 반대)

### 9.2 공매도 한도/증거금(백테스트 가정 포함)
- 실운영(사용자 제공):
  - 개인전문투자자 기준, **동일 시점에 대주 매도 상태의 총 포지션 규모(명목)가 최대 6억 원**을 넘지 않도록 제한한다.
  - T+2 정산에 따라 한도 회복 타이밍이 영향을 받을 수 있으나, 초기 구현에서는 **“현재 오픈 숏 명목” 기준으로 단순 관리**한다(추후 정교화 가능).
- 백테스트 가정(확정):
  - 증거금 100% 가정 + 안전 마진 **30,000,000 KRW(3천만)** 버퍼를 적용
  - 따라서 백테스트 상 숏 총 한도는 **570,000,000 KRW (5.7억)** 으로 가정한다.

### 9.3 대주 보유 기간 제한(확정)
- 대주 거래 포지션은 **90 거래일 이내 청산**해야 한다.
  - 90 거래일을 초과하면 시스템은 **강제 청산(가장 빠른 유효 거래일에 집행)** 한다.

---

## 10. 전략 개요(Strategy)
- 전략 철학: **추세 추종(Trend Following)**
- 포지션 관리 기법(필수):
  - 리스크 기반 베팅 사이즈 결정(Risk-based position sizing)
  - 진입 손절(Initial stop-loss)
  - 트레일링 스탑(Trailing stop)
  - 피라미딩(Pyramiding)

---

## 11. 알림/보고(텔레그램 봇)
- 텔레그램(또는 동등한 메시징 봇)을 통해 아래 이벤트를 통지한다.
  - 주문 생성/주문 접수/체결/미체결/취소 결과
  - API 오류/레이트리밋/데이터 업데이트 실패 등 시스템 장애
  - 공매도 한도/대주 90거래일 제한 임박/초과 등 제약 관련 경보
  - (선택) 전략 신호 요약/일일 리포트

---

## 12. 별도 문서로 분리 관리(본 spec에서는 참조만)
아래 항목은 본 spec에서 범위를 명시하되, 상세 규칙은 별도 문서로 관리한다.

- 자금관리 규칙(최대 포지션 수, 종목당 비중, 익스포저 한도 등): `capital_management_rules.md`
- 위험 경보(Guard / Alert) 규칙: `risk_alert_rules.md`
- 결산/자본 업데이트 상세: `capital_reconciliation.md`

---

## 13. TBD(추후 확정/정교화 가능 항목)
- 평가 구간 경계(연말)에서 포지션 캐리오버/강제청산 처리(성과 측정 경계 일관성)
- 대주 이자 일할 계산 방식(365 vs 252, 실제 날짜 차이 처리)
- T+2 정산의 한도 회복/현금 흐름을 백테스트에서 얼마나 정교하게 모사할지
- 유니버스 연단위 업데이트를 실제 구성 변경과 정확히 매핑할지, 혹은 “고정 유니버스”로 단순화할지
