# 회계 규칙 (Backtest 중심) — Equity Curve / NAV (KRX, Long + 대주 Short)
> 목적: **백테스트 모드에서 사용할 회계/자산 평가 규칙**을 정의한다.  
> 핵심 목표는 (1) Equity Curve를 일관되게 관리하고, (2) 성과 지표(CAGR 등)를 **평가액(NAV) 기반**으로 계산하는 것이다.  
> 실제 거래(라이브)에서는 **브로커(KIS) API의 계좌 평가값을 소스 오브 트루스로 사용**하고, 본 문서는 라이브 회계의 “정밀 시뮬레이션”을 목적으로 하지 않는다.  
> 업데이트: 2026-02-10 (Asia/Seoul)

---

## 0) 범위(Scope) 및 설계 철학
### 0.1 Backtest 모드의 우선순위
- 구현 복잡도를 낮추기 위해 **T+2 결제의 정밀 시뮬레이션은 생략**한다.
- 대신 다음을 정확히 반영한다.
  - 롱/숏 포지션의 **일별 평가(mark-to-market)**
  - 프로젝트 확정 비용 규칙(매도 시 0.3% 차감)
  - 대주(숏) 이자: **월 1회 정산**으로 단순화
  - CMA ↔ 트레이딩 계좌 이동은 **NAV 변화 없이 자금 위치만 이동**하는 이벤트로 모델링(선택)

### 0.2 Live 모드의 원칙(본 문서의 참고 사항)
- 라이브에서는 배당금/대주이자/세부 수수료 등 “자잘한 델타”가 자동으로 발생하므로,
  - **KIS API로 계좌 정보를 주기적으로 받아 내부 상태를 동기화**한다.
- 이 동기화 로직은 “회계 자체를 시뮬레이션”하기보다는,
  - **브로커 평가값을 기준으로 내부 값(가용금액/NAV)을 보정(reconcile)** 하는 방식이다.

---

## 1) 백테스트용 계좌 상태 데이터 모델
백테스트에서는 다음 상태만 유지하면 충분하다.

### 1.1 Cash bucket
- `cash_cma` : CMA(대기자금) 잔고 (KRW)
- `cash_trading_free` : 트레이딩 계좌 가용 현금 (KRW)
- `cash_trading_locked` : 트레이딩 계좌 제한 현금(대주 매도대금 담보 성격) (KRW)

> 단순 백테스트에서는 `cash_cma`를 쓰지 않고 **통합 현금 1개로** 구현해도 된다.  
> 다만 실제 운영 계획이 “CMA에 보관 → 신호 발생 시 전액 이동 → 거래 후 재이체”이므로,  
> 리포팅/추적용으로 분리해두는 편이 자연스럽다.

### 1.2 Position valuation
- `holding_value` : 롱 평가금액 = Σ(롱 수량 × 당일 종가)
- `short_liability` : 숏 평가부채 = Σ(숏 수량 × 당일 종가)

### 1.3 NAV(Equity)
- **백테스트 NAV(=Equity Curve의 값)** 은 다음으로 정의한다.

`NAV = cash_cma + cash_trading_free + cash_trading_locked + holding_value - short_liability`

- NAV는 평가액이므로, 성과(CAGR 등)는 NAV 기반으로 계산한다.

---

## 2) CMA ↔ 트레이딩 계좌 이동 모델(운영 방식 반영)
운영 계획(대기자금 CMA 보관)을 백테스트에도 “표시/흐름” 수준으로 반영한다.

### 2.1 전제(백테스트 단순화)
- 이체는 **즉시(instant)**, **수수료/지연 없음**으로 가정한다.
- 이체는 단지 현금 bucket만 이동시키며, **NAV는 변하지 않는다**.

### 2.2 이체 규칙(권장)
- 신규 진입 신호가 발생해 “주문을 생성”하는 날 아침(예: T+1 09:00 주문 직전):
  - `cash_trading_free += cash_cma`
  - `cash_cma = 0`
- 모든 포지션이 청산되어 포트폴리오가 완전히 flat이고(롱=0, 숏=0),
  - 당일 장 마감 이후:
    - `cash_cma += cash_trading_free`
    - `cash_trading_free = 0`
  - `cash_trading_locked`도 0이어야 정상(flat이면 담보금이 남지 않도록 처리)

> 주: 라이브에서는 이체가 “수동/외부 절차”가 될 수 있다.  
> 따라서 라이브에서의 이체는 **외부 캐시플로우 이벤트**로 기록하고,  
> 브로커 API 스냅샷으로 최종 값(예수금)을 맞추는 방식이 더 안전하다.

---

## 3) 거래 비용 규칙(프로젝트 확정 사항)
- 거래비용 근사: 왕복 0.3%  
- 적용:
  - **매수(buy) 비용 0%**
  - **매도(sell) 비용 0.3%** (거래세+수수료+슬리피지 포함)

따라서:
- 모든 “매도 체결”에 대해 `net_proceeds = gross_proceeds * (1 - 0.003)`

---

## 4) 트랜잭션 처리 규칙(Backtest)
> 본 섹션은 **T+2 결제를 정밀하게 시뮬레이션하지 않고**, 체결 시점에 현금을 즉시 갱신하는 단순 규칙이다.

### 4.1 롱 매수(Long Entry)
- 체결 시점에:
  - `cash_trading_free -= gross_buy_amount`  (매수 비용 0%)
  - 롱 수량 증가
- NAV 평가(장 마감)는 종가로 `holding_value`에 반영된다.

### 4.2 롱 매도(Long Exit)
- 체결 시점에:
  - `cash_trading_free += gross_sell_amount * (1 - 0.003)`
  - 롱 수량 감소(또는 제거)

### 4.3 대주매도(숏 진입, Short Entry)
- 체결 시점에:
  - `cash_trading_locked += gross_short_sell_amount * (1 - 0.003)`
  - 숏 수량 증가
- 숏 부채는 매일:
  - `short_liability = Σ(qty_short × close_price)` 로 재평가된다.
- **숏 명목(notional) 기준값**(별도 제약/이자 계산에 사용):
  - `short_notional_basis = Σ(qty_short_open × short_sell_fill_price)`
  - (요구사항) 숏 명목 한도는 **대주매도 체결가 기준**을 사용한다.

### 4.4 대주매수(숏 청산, Short Cover)
- 체결 시점에:
  - `cash_trading_locked -= gross_short_buy_amount` (매수 비용 0%)
  - 숏 수량 감소(또는 제거)
- 숏이 완전히 0이 되면(전체 숏 포지션이 종료되면):
  - 담보 해제 단순화(권장):
    - `cash_trading_free += cash_trading_locked`
    - `cash_trading_locked = 0`

> 주: 실제 계좌에서는 담보 해제 타이밍이 다를 수 있으나, 백테스트에서는 단순화한다.

---

## 5) 대주 이자(연 4.5%) — 월 1회 정산(Backtest 단순화)
### 5.1 기본 규칙(확정)
- 대주 이자는 **월 1회**, **다음 달 첫 거래일**에 계좌에서 차감되는 것으로 시뮬레이션한다.
  - 예: 1월 보유분 이자 → 2월 첫 거래일에 차감

### 5.2 이자 계산 방식(권장: 일별 누적 → 월초 차감)
- 일별로 아래의 “이자 누적액”을 계산/누적한다:
  - `daily_interest = short_notional_basis_day * (0.045 / 365)`
- 월이 바뀌는 “첫 거래일”에:
  - `cash_trading_free -= accrued_interest_month`
  - `accrued_interest_month = 0`

> `short_notional_basis_day`는 “대주매도 체결가 기준의 오픈 숏 명목”을 의미한다.  
> (요구사항: 숏 명목 한도 정의와 동일한 기준을 공유)

### 5.3 현금 부족 처리(백테스트)
- `cash_trading_free`가 부족하면:
  - (단순) `cash_trading_free`가 음수가 되도록 허용하거나,
  - (운영 방식 반영) `cash_cma`에서 추가 이체하여 충당하는 정책을 둘 수 있다.
- 초기 구현에서는 단순화를 위해 **음수 허용** 또는 **CMA에서 자동 충당(옵션)** 중 하나를 선택한다.

---

## 6) 가격 데이터 및 평가
- 평가가격은 기본적으로 **일봉 종가(Close)** 를 사용한다.
- 프로젝트 전제:
  - 주가는 **수정주가(Adjusted Price)** 기반으로 사용
  - 배당은 “전략적으로 무시”  
- 백테스트에서는 배당 현금 유입을 별도로 모델링하지 않는다.

> 라이브에서는 배당금이 자동 입금되므로, 내부 시뮬레이션이 아닌 **브로커 계좌 업데이트**로 흡수한다(섹션 8 참조).

---

## 7) Daily Snapshot(스냅샷) 및 Equity Curve 저장
### 7.1 Backtest 스냅샷(내부 계산치)
매 거래일 EOD에 다음을 저장한다.

- `date`
- `cash_cma`, `cash_trading_free`, `cash_trading_locked`
- `holding_value`, `short_liability`
- `nav_internal` (= 위 정의 NAV)

### 7.2 성과(CAGR) 계산
- CAGR은 NAV 기반으로 계산한다.

`CAGR = ( NAV_end / NAV_start ) ** (1/years) - 1`

- 권장:
  - `years = (end_date - start_date).days / 365.0`

---

## 8) Live 모드: 브로커 API 기반 동기화(reconcile) 규칙(참고/요구 반영)
> 본 문서는 백테스트 중심이지만, 운영 요구사항을 만족하기 위해 동기화/알림 규칙을 명시한다.

### 8.1 배당금/대주 이자 등 “자잘한 델타” 처리
- 라이브에서는 배당금/대주 이자/세부 수수료/담보 변동 등이 자동 반영된다.
- 시스템은 주기적으로 KIS API로 계좌 정보를 조회하여:
  - 내부의 `cash_available`(가용 금액) 및 필요 시 NAV를 업데이트한다.
- **델타 알림(요구사항)**
  - 내부 가용금액(예상치)과 브로커 가용금액(실제치)의 차이가
    - `|delta_cash| >= 5,000,000 KRW` 이면 사용자에게 알림(텔레그램 등)

> “가용금액”은 라이브에서 실제 주문 가능액과 직접 연결되므로, 내부 추정값보다 **브로커 값이 우선**이다.

### 8.2 회계 스냅샷: 브로커 값 vs 내부 계산치 동시 기록 + 알림
- 매일(또는 실행 배치마다) 아래를 저장한다.
  - `nav_internal` : 내부 계산치(NAV)
  - `nav_broker` : 브로커 평가값(총자산/평가예탁자산 등)
  - (필요 시) `cash_available_internal`, `cash_available_broker`
- **스냅샷 괴리 알림(요구사항)**
  - `|nav_broker - nav_internal| >= 500,000 KRW` 이면 알림 송신

> CMA ↔ 트레이딩 계좌 이체가 존재하므로,  
> “브로커 평가값”은 한 계좌만 보면 큰 차이가 날 수 있다.  
> 따라서 라이브에서는 (가능하면) **CMA 계좌 + 트레이딩 계좌를 합산한 NAV**를 기준으로 비교하는 것을 권장한다.

---

## 9) 논의가 필요한 포인트(검토 결과)
1) **백테스트에서 T+2를 완전히 생략해도 되는지**
   - 현재 요구: “정밀 불요” → 생략이 합리적
   - 다만 숏 담보/재진입 한도(T+2 회복)까지 엄밀히 맞추려면 향후 확장이 필요

2) **라이브에서 CMA 이체를 자동화할지(가능/불가능)**
   - 증권사/은행 이체 자동화는 API 범위에 따라 제약이 있을 수 있음
   - 자동화가 어렵다면, “이체는 수동”으로 두고 **브로커 스냅샷으로만 정합성 유지**하는 편이 현실적

3) **5,000,000원/500,000원 알림 기준은 절대값 기준으로 확정**
   - 운영 중 계좌 규모가 변하면(예: 7억→10억) 상대기준(%) 병행이 유용할 수 있음
